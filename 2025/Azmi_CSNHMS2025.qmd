---
title: "Estimating Prevalence Correctly"
subtitle: "Complex Sampling in National Surveys"
author:
  - name: Dr Mohd Azmi Bin Suliman
    orcid: 0000-0002-2125-3811
    email: azmi.suliman@moh.gov.my
    affiliations: Pusat Penyelidikan Penyakit Tak Berjangkit, Institut Kesihatan Umum
date: 2025-11-16
date-format: "dddd, DD MMMM YYYY"
embed-resources: true
format:
  clean-revealjs:
    show-notes: separate-page
    slide-number: true
    footer: "Complex Sampling Design | NHMS | R Conference 2025"
    lightbox: true
execute:
  echo: false
  warning: false
  message: false
editor:
  markdown:
    wrap: sentence
---

```{r}
#| label: setup
#| echo: false

## setup

set.seed(2025)
pacman::p_load(tidyverse, arrow, summarytools, gtsummary, survey, srvyr, gt)

####
## DOSM Population
####

dosm_pop <- read_parquet(paste0("https://storage.dosm.gov.my/population/", 
                                "population_malaysia.parquet")) %>% 
  filter(date == as.Date("2025-01-01"), 
         sex %in% c("male", "female"), 
         age != "overall") %>% 
  rename(pop_k = population)

dosm_pop_poppyd <- dosm_pop %>% 
  filter(ethnicity == "overall")

####
## DOSM Population Pyramid
####

pyr_df <- dosm_pop_poppyd %>%
  mutate(age_start = readr::parse_number(age), 
         age_fct = fct_reorder(age, age_start), 
         pop_sign = if_else(sex == "male", -pop_k, pop_k))

my_pyr_plot <- ggplot(pyr_df, 
                      aes(x = age_fct, y = pop_sign, fill = sex)) +
  geom_col(width = 0.9) +
  coord_flip() +
  scale_y_continuous(labels = function(x) scales::comma(abs(x)), 
                     breaks = seq(-3500, 3500, by = 500), 
                     limits = c(-1900, 1700), 
                     expand = expansion(mult = c(0.02, 0.02))) +
  labs(title = "Malaysia Population Pyramid, 2025", 
       x = "Age group (years)", 
       y = "Population (thousands)", 
       fill = "Sex") +
  theme_minimal(base_size = 13) +
  theme(panel.grid.minor = element_blank())

####
## Simulation Dataset
####

dmsi_ds <- tibble(age_group = c("18-29","30-39","40-49","50-59","60+"), 
       n_total = c(200, 200, 200, 200, 300)) %>% 
  mutate(male = as.integer(round(.4*n_total)), 
         female = n_total - male) %>% 
  pivot_longer(male:female, names_to = "gender", 
               values_to = "n_gender") %>% 
  mutate(malay = as.integer(round(.65*n_gender)), 
         chinese = as.integer(round(.2*n_gender)), 
         indian = n_gender - malay - chinese) %>% 
  pivot_longer(malay:indian, names_to = "ethnicity", 
               values_to = "n_ethnic") %>% 
  uncount(n_ethnic) %>% 
  select(-starts_with("n_")) %>% 
  group_by(age_group) %>% 
  mutate(age = case_when(
    age_group == "18-29" ~ sample(18:29, n(), replace = T), 
    age_group == "30-39" ~ sample(30:39, n(), replace = T), 
    age_group == "40-49" ~ sample(40:49, n(), replace = T), 
    age_group == "50-59" ~ sample(50:59, n(), replace = T), 
    age_group == "60+" ~ sample(60:90, n(), replace = T))) %>% 
  ungroup() %>% 
  mutate(dm = c(rep(0, 50), rep(1, 2), # 18, male, malay
                rep(0, 15), rep(1, 1), 
                rep(0, 11), rep(1, 1), 
                rep(0, 76), rep(1, 2), # 18, female
                rep(0, 23), rep(1, 1), 
                rep(0, 17), rep(1, 1), 
                rep(0, 48), rep(1, 4), # 30, male
                rep(0, 15), rep(1, 1), 
                rep(0, 11), rep(1, 1), 
                rep(0, 73), rep(1, 5), # 30, female
                rep(0, 23), rep(1, 1), 
                rep(0, 16), rep(1, 2), 
                rep(0, 45), rep(1, 7), # 40, male, malay
                rep(0, 14), rep(1, 2), 
                rep(0, 9), rep(1, 3), 
                rep(0, 65), rep(1, 13), # 40, female
                rep(0, 20), rep(1, 4), 
                rep(0, 13), rep(1, 5), 
                rep(0, 37), rep(1, 15), # 50, male
                rep(0, 12), rep(1, 4), 
                rep(0, 6), rep(1, 6), 
                rep(0, 55), rep(1, 23), # 50, female
                rep(0, 18), rep(1, 6), 
                rep(0, 9), rep(1, 9), 
                rep(0, 49), rep(1, 29), # 60, male
                rep(0, 16), rep(1, 8), 
                rep(0, 7), rep(1, 11), 
                rep(0, 72), rep(1, 45), # 60, female
                rep(0, 23), rep(1, 13), 
                rep(0, 10), rep(1, 17)), 
         dm = factor(dm, levels = c(0, 1), labels = c("No DM", "DM")), 
         adw = 20) %>%  # assume all have same dw = 20, RR = 100%
  mutate(my = "Overall", .before = 1)

####
## Sim Sample Pyramid
####

dosm_labels  <- c(paste(seq(0, 80, by = 5), 
                        seq(4, 84, by = 5), sep = "-"), 
                  "85+")

dmsi_pyr <- dmsi_ds %>%
  mutate(age_dosm = cut(age,
                        breaks = c(seq(0, 85, by = 5), Inf),
                        labels = dosm_labels,
                        include.lowest = TRUE,
                        right = FALSE)) %>%
  count(age_dosm, gender, name = "n") %>%
  complete(age_dosm = factor(dosm_labels, levels = dosm_labels),
           gender = c("male", "female"),
           fill = list(n = 0)) %>%    # fill empty age groups with 0
  mutate(pop_sign = if_else(gender == "male", -n, n))

dmsi_pyr_plot <- ggplot(dmsi_pyr, 
                        aes(x = age_dosm, y = pop_sign, fill = gender)) +
  geom_col(width = 0.9) +
  coord_flip() +
  scale_y_continuous(labels = function(x) abs(x), 
                     limits = c(-75, 75)) +
  labs(title = "Simulated Sample Pyramid",
       x = "Age group (years)",
       y = "Sample size (count)",
       fill = "Gender") +
  theme_minimal(base_size = 13) +
  theme(panel.grid.minor = element_blank())

####
## Sampling Weight
####

age_map <- tribble(~age,   ~age_band, ~w, 
                   "15-19","18-29",   2/5, "20-24","18-29",   1, 
                   "25-29","18-29",   1, 
                   "30-34","30-39",   1, "35-39","30-39",   1, 
                   "40-44","40-49",   1, "45-49","40-49",   1, 
                   "50-54","50-59",   1, "55-59","50-59",   1, 
                   "60-64","60+",     1, "65-69","60+",     1, 
                   "70-74","60+",     1, "75-79","60+",     1, 
                   "80-84","60+",     1, "85+",  "60+",     1)

dosm_adult_pop <- dosm_pop %>%
  filter(sex %in% c("male","female"),
         ethnicity %in% c("bumi_malay","chinese","indian")) %>%
  mutate(ethnicity = recode(ethnicity, "bumi_malay" = "malay")) %>%
  left_join(age_map, by = "age") %>%
  filter(!is.na(age_band)) %>%
  mutate(pop_k_contrib = pop_k * w) %>% # thousands of persons
  group_by(sex, ethnicity, age_band) %>%
  summarise(pop_k = sum(pop_k_contrib), .groups = "drop") %>%
  mutate(age_band = factor(age_band, 
                           levels = c("18-29","30-39","40-49","50-59","60+")), 
         sex = factor(sex, levels = c("male", "female")), 
         ethnicity = factor(ethnicity, 
                            levels = c("malay", "chinese", "indian"))) %>%
  arrange(sex, ethnicity, age_band)

dmsi_ds_popfct <- dmsi_ds %>% 
  as_survey_design(ids = 1, 
                   weights = adw) %>% 
  group_by(gender, ethnicity, age_group) %>% 
  summarise(n_samp = n(), 
            est_pop = survey_total(), 
            .groups = "drop") %>% 
  left_join(., dosm_adult_pop, 
            by = join_by(gender == sex, 
                         ethnicity, 
                         age_group == age_band)) %>% 
  select(-ends_with("_se")) %>% 
  mutate(pop_fct = pop_k / est_pop,
         gender = factor(gender, levels = c("male", "female")), 
         ethnicity = factor(ethnicity, levels = c("malay", "chinese", "indian")))
  
dmsi_ds_final <- left_join(dmsi_ds, 
          dmsi_ds_popfct %>% 
            select(gender, ethnicity, age_group, pop_fct), 
          by = join_by(age_group, gender, ethnicity)) %>% 
  mutate(final_wt = adw * pop_fct)

####
## Complex Sampling Analysis
####

dmsi_svy <- dmsi_ds_final %>% 
  as_survey_design(ids = 1, # In this simulation, no clustering
                   strata = NULL, # In this simulation, no stratifying
                   weights = final_wt)

####
## Weighted Sample Pyramid (Post-Stratified)
####

dmsiwt_pyr <- dmsi_ds_final %>%
  mutate(age_dosm = cut(age,
                        breaks = c(seq(0, 85, by = 5), Inf),
                        labels = dosm_labels,
                        include.lowest = TRUE,
                        right = FALSE)) %>%
  group_by(age_dosm, gender) %>%
  summarise(weighted_n = sum(final_wt, na.rm = TRUE), .groups = "drop") %>%
  complete(age_dosm = factor(dosm_labels, levels = dosm_labels),
           gender = c("male", "female"),
           fill = list(weighted_n = 0)) %>%
  mutate(pop_sign = if_else(gender == "male", -weighted_n, weighted_n))

dmsiwt_pyr_plot <- ggplot(dmsiwt_pyr, 
                          aes(x = age_dosm, y = pop_sign, fill = gender)) +
  geom_col(width = 0.9) +
  coord_flip() +
  scale_y_continuous(labels = function(x) abs(round(x, 0)),
                     limits = c(-max(dmsiwt_pyr$weighted_n),
                                max(dmsiwt_pyr$weighted_n))) +
  labs(title = "Weighted Sample Pyramid (Post-Stratified)",
       x = "Age group (years)",
       y = "Weighted count",
       fill = "Gender") +
  theme_minimal(base_size = 13) +
  theme(panel.grid.minor = element_blank())

####
## Prevalence Tables (Crude vs Weighted)
####

tbl_crude <- dmsi_ds %>% 
  tbl_summary(include = c(my, gender, age_group), 
              by = dm, 
              digits = everything() ~ c(0, 1), 
              percent = "row") %>% 
  modify_spanning_header(all_stat_cols() ~ "**Sample Count (Proportion)**") %>% 
  modify_column_hide(stat_1)

tbl_weighted <- dmsi_svy %>% 
  tbl_svysummary(include = c(my, gender, age_group), 
                 by = dm, 
                 digits = everything() ~ c(0, 1), 
                 percent = "row") %>% 
  modify_spanning_header(all_stat_cols() ~ "**Est. Pop. (Prevalence)**") %>% 
  modify_column_hide(stat_1)

tbl_prop_prev <- tbl_merge(tbls = list(tbl_crude, tbl_weighted), 
                           tab_spanner = c("**Crude (Unweighted)**", 
                                           "**Weighted (Post-Stratified)**")) %>%
  modify_caption("**Comparison of Crude and Weighted Estimates of Diabetes Prevalence**")

```

```{css}
code.sourceCode {font-size: 1.0em;}
```

---

# Institut Kesihatan Umum (IKU)

- Conducts the **National Health and Morbidity Survey (NHMS)**.  
- Generates national evidence on **population health and NCDs**.  
- Supports **policy and programme planning** with reliable data.

::: {.notes}
IKU leads national health surveys that provide Malaysia’s core health statistics.  
The NHMS is its flagship programme for population health surveillance and evidence-based policy support.
:::

---

# From Population to Sample

![](Images/Group-13.jpg){width="90%"}

- We study populations through **samples**, not by measuring everyone.  
- Samples may differ in **age, sex, or ethnicity** distribution.  
- National surveys must ensure **representativeness**, not just inclusion.

::: {.notes}
Every survey uses samples to describe populations.  
However, samples may not mirror the true population structure, leading to biased estimates if weighting isn’t applied.
:::

---

# Malaysian Population, 2025

```{r}
my_pyr_plot
```

- Data: **Department of Statistics Malaysia (DOSM)**  
- Shows Malaysia’s **age–sex structure**.

::: {.notes}
This is Malaysia’s official population pyramid (as of 2025).  
Note the large base of working-age adults and a growing older population.
:::

---

# What is Complex Sampling?

- **Stratification** ensures key subgroups are represented.  
- **Clustering** groups respondents for logistical efficiency.  
- **Unequal selection probabilities** corrected with weights.  
- Requires **design-based analysis** for valid inference.

::: {.notes}
Complex sampling combines stratification and clustering to achieve efficient, representative national surveys.  
Since some groups are over- or under-sampled, weighting is needed to correct their contribution to population estimates.
:::

---

# Why Use Complex Sampling?

- Covers **diverse populations** efficiently.  
- Reduces **cost and fieldwork burden**.  
- Enables **accurate national and state estimates**.

::: {.notes}
Complex designs make national health surveys operationally feasible and statistically robust, balancing representativeness and cost.
:::

---

# Example (NHMS 2023) – Diabetes Prevalence

| **Age Group** | **% with DM** | **95% CI** |
|:--------------|--------------:|:-----------:|
| 18–29 | 3.2 | 2.2–4.6 |
| 30–39 | 6.5 | 5.2–8.1 |
| 40–49 | 15.2 | 13.2–17.4 |
| 50–59 | 28.8 | 25.0–33.0 |
| 60+ | 38.0 | 35.4–40.7 |

::: {.notes}
Diabetes prevalence rises sharply with age.  
These national estimates come from a complex survey design that accounts for stratification, clustering, and weighting.
:::

---

# Simulation Dataset

- 1,100 synthetic respondents.  
- Age groups: 18–29 to 60+.  
- Sex ratio 40 % male / 60 % female.  
- Ethnicity: 65 % Malay, 20 % Chinese, 15 % Indian.  
- Diabetes prevalence ≈ 22 %.

::: {.notes}
To demonstrate post-stratification, we use a simulated dataset reflecting Malaysia’s demographic mix and realistic diabetes prevalence.
:::

---

# Crude Prevalence

```{r}
dmsi_ds %>% 
  tbl_summary(include = dm,
              digits = all_categorical() ~ c(0,1))
```

- Crude prevalence ≈ 22 %.  
- Does this represent Malaysia accurately?

::: {.notes}
Crude prevalence simply divides positive cases by total respondents.  
If the sample is unbalanced by age or sex, this crude figure will be biased.
:::

---

# Sample vs Population

::: {layout-ncol="2"}
```{r}
my_pyr_plot
```
```{r}
dmsi_pyr_plot
```
:::

- Sample has **more older and female** respondents.

::: {.notes}
Compare the national (left) and sample (right) pyramids.  
Older adults and females are over-represented — a common field sampling outcome.
:::

---

# Why Adjust Weights?

- To match sample structure to true population totals.  
- Ensures estimates represent Malaysia accurately.

::: {.notes}
Post-stratification (a type of calibration) re-weights the sample so that totals by age, sex, and ethnicity equal the official population counts.
:::

---

# Post-Stratification

- Aligns weights by **age, sex, ethnicity**.  
- Corrects for unequal sampling probabilities.

```{r}
dmsi_ds_popfct %>% 
  arrange(age_group, gender, ethnicity) %>% 
  filter(age_group %in% c("18-29","40-49","60+"),
         ethnicity != "chinese") %>% 
  select(age_group, everything()) %>% 
  gt() %>% 
  cols_label(age_group="Age Group",gender="Sex",
             ethnicity="Ethnicity",n_samp="Sample Count (n)",
             est_pop="Init. Est. Pop.",
             pop_k="Malaysia Population ('000)",
             pop_fct="Post-strat Factor")
```

::: {.notes}
Post-stratification uses known demographic totals to adjust sampling weights.  
Groups with post-strat factor > 1 are under-sampled and up-weighted; those < 1 are over-sampled and down-weighted.
:::

---

# Post-Strat Effect – Age

- Younger adults up-weighted (f > 1).  
- Older adults down-weighted (f < 1).

```{r}
dmsi_ds_popfct %>%
  arrange(gender,age_group,ethnicity) %>%
  filter(ethnicity=="malay") %>%
  gt()
```

::: {.notes}
The youngest age groups were under-represented in our sample, so their weights are inflated.  
This ensures their contribution matches the national age distribution.
:::

---

# Post-Strat Effect – Gender

- Males under-sampled → weight ↑.  
- Females over-sampled → weight ↓.

```{r}
dmsi_ds_popfct %>%
  arrange(age_group,gender,ethnicity) %>%
  filter(age_group %in% c("18-29","40-49","60+"),
         ethnicity=="malay") %>%
  gt()
```

::: {.notes}
Male respondents were fewer than expected.  
Post-stratification increases male weights and reduces female weights so that the total mirrors the real population ratio.
:::

---

# Before and After Weighting

::: {layout-ncol="2"}
```{r}
dmsi_pyr_plot
```
```{r}
dmsiwt_pyr_plot
```
:::

- Weighting restores population structure.

::: {.notes}
The weighted pyramid (right) now mirrors Malaysia’s actual age–sex pattern, showing the success of post-stratification in correcting sample imbalance.
:::

---

# Corrected Prevalence (Weighted)

```{r}
tbl_prop_prev
```

- Weighted estimates reflect true population.  
- Crude estimates reflect only sample.

::: {.notes}
Weighted prevalence now accounts for unequal selection probabilities.  
This approach provides unbiased national estimates with correct standard errors.
:::

---

# Caveats in Complex Sampling

- Needs a **known sampling frame**.  
- Requires larger sample to offset design effect.  
- **Intra-cluster correlation** reduces precision.  
- Standard tests without weights → invalid results.

::: {.notes}
Complex sampling assumes known selection probabilities (e.g., list of houses from DOSM).  
Design effects increase variance, so larger samples are needed.  
Ignoring weights leads to underestimated standard errors and misleading confidence intervals.
:::

---

# Summary

- Complex sampling improves representativeness.  
- Weighting corrects for unequal selection.  
- Post-stratification aligns sample to population.  
- Corrected estimates are valid and comparable nationally.

::: {.notes}
In national surveys like NHMS, complex sampling and calibration ensure data accurately represent Malaysia’s population.  
Understanding weighting and design effects is key to valid public health inference.
:::
